var Pn=Object.defineProperty,Mn=Object.defineProperties;var kn=Object.getOwnPropertyDescriptors;var Le=Object.getOwnPropertySymbols;var On=Object.prototype.hasOwnProperty,$n=Object.prototype.propertyIsEnumerable;var Re=(R,T,A)=>T in R?Pn(R,T,{enumerable:!0,configurable:!0,writable:!0,value:A}):R[T]=A,Nt=(R,T)=>{for(var A in T||(T={}))On.call(T,A)&&Re(R,A,T[A]);if(Le)for(var A of Le(T))$n.call(T,A)&&Re(R,A,T[A]);return R},Gt=(R,T)=>Mn(R,kn(T));var D=(R,T,A)=>new Promise((j,w)=>{var g=I=>{try{z(A.next(I))}catch(P){w(P)}},xt=I=>{try{z(A.throw(I))}catch(P){w(P)}},z=I=>I.done?j(I.value):Promise.resolve(I.value).then(g,xt);z((A=A.apply(R,T)).next())});(function(){"use strict";(function(){const n=document.createElement("script");n.src="/js/library-loader.js",document.head.appendChild(n)})();const R=new URLSearchParams(window.location.search),T=R.get("debug")==="true",A=localStorage.getItem("debug")==="true";if(window.debug=T||A||!1,T!==A&&(T?localStorage.setItem("debug","true"):R.has("debug")&&localStorage.removeItem("debug")),window._originalConsoleLog=console.log,console.log=function(...n){window.debug&&window._originalConsoleLog(...n)},window.debug){window._originalConsoleLog("%c Debug Mode Enabled","color: #00ff00; font-weight: bold; font-size: 16px"),window._originalConsoleLog("To disable: add ?debug=false to URL or run dashy.debug(false)");const n=document.createElement("div");n.id="debug-indicator",n.textContent="DEBUG",n.style.cssText=`
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        z-index: 10000;
        pointer-events: none;
    `,document.addEventListener("DOMContentLoaded",()=>{document.body.appendChild(n)})}window.dashy={debug:function(n=!0){return window.debug=n,n?(localStorage.setItem("debug","true"),window._originalConsoleLog("%c Debug Mode Enabled","color: #00ff00; font-weight: bold"),window._originalConsoleLog("Refresh page to see all debug logs")):(localStorage.removeItem("debug"),window._originalConsoleLog("%c Debug Mode Disabled","color: #ff0000; font-weight: bold")),n?"Debug enabled":"Debug disabled"},perf:function(){const n={fps:window._fps||0,frameTime:window._frameTime||0,drawCalls:window._drawCalls||0,canvasOps:window._canvasOps||0};return window._originalConsoleLog("%cPerformance Metrics","color: #00aaff; font-weight: bold"),window._originalConsoleLog(n),n},help:function(){window._originalConsoleLog("%cDashy Debug Commands:","color: #ffaa00; font-weight: bold; font-size: 14px"),window._originalConsoleLog("dashy.debug(true/false) - Enable/disable debug mode"),window._originalConsoleLog("dashy.perf() - Show performance metrics"),window._originalConsoleLog("dashy.help() - Show this help"),window._originalConsoleLog(`
URL Parameters:`),window._originalConsoleLog("?debug=true - Enable debug mode"),window._originalConsoleLog("?debug=false - Disable debug mode")}},(function(){let t=0,e=null,s=0;function a(i,o,r){const d=document.getElementById("hud-page");if(!d||!d.classList.contains("active"))return;const l=window.innerWidth,c=window.innerHeight;if(i>l-100&&o>c-100){const h=Date.now();if(h-s<100){window._originalConsoleLog(`[Debug Toggle] Ignoring duplicate ${r} event`);return}if(s=h,t++,window._originalConsoleLog(`[Debug Toggle] ${r} count: ${t}/5 (at ${i},${o})`),e&&clearTimeout(e),e=setTimeout(()=>{t=0,window._originalConsoleLog("[Debug Toggle] Tap count reset to 0")},1e3),t===5){t=0;const _=!window.debug;window.dashy.debug(_);const u=document.createElement("div");u.textContent=_?"Debug Enabled":"Debug Disabled",u.style.cssText=`
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: ${_?"rgba(0, 255, 0, 0.9)":"rgba(255, 0, 0, 0.9)"};
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    font-size: 24px;
                    font-weight: bold;
                    z-index: 10001;
                    pointer-events: none;
                `,document.body.appendChild(u),navigator.vibrate&&navigator.vibrate(_?[100,50,100]:[200]),setTimeout(()=>{u.remove(),location.reload()},1500)}}}document.addEventListener("touchend",i=>{const o=i.changedTouches[0];o.clientX>window.innerWidth-100&&o.clientY>window.innerHeight-100&&a(o.clientX,o.clientY,"Touch")}),document.addEventListener("click",i=>{i.clientX>window.innerWidth-100&&i.clientY>window.innerHeight-100&&a(i.clientX,i.clientY,"Click")})})();const j={events:{},on(n,t){return this.events[n]||(this.events[n]=[]),this.events[n].push(t),()=>this.off(n,t)},off(n,t){this.events[n]&&(this.events[n]=this.events[n].filter(e=>e!==t))},emit(n,t){this.events[n]&&this.events[n].forEach(e=>e(t))}},w={_data:{settings:{},localSettings:{},ui:{currentPage:"files",navBarVisible:!1,hudModeEnabled:!1,showVideoInHud:!0},files:{currentPath:"/",items:[]}},get(n){return n.split(".").reduce((e,s)=>e==null?void 0:e[s],this._data)},set(n,t){const e=n.split("."),s=e.pop(),a=e.reduce((o,r)=>(o[r]||(o[r]={}),o[r]),this._data),i=a[s];i!==t&&(a[s]=t,j.emit("state:change",{path:n,value:t,oldValue:i}),j.emit(`state:${n}`,t))},subscribe(n,t){return j.on(`state:${n}`,t)}};function g(n,t,e={}){const s=document.createElement(n);return t&&(s.className=t),Object.entries(e).forEach(([a,i])=>{a==="dataset"?Object.entries(i).forEach(([o,r])=>{s.dataset[o]=r}):s[a]=i}),s}function xt(n){if(n===0)return"0 B";const t=1024,e=["B","KB","MB","GB","TB"],s=Math.floor(Math.log(n)/Math.log(t));return parseFloat((n/Math.pow(t,s)).toFixed(1))+" "+e[s]}const z=new Set,I=new Set;function P(n,t){const e=setTimeout(()=>{n(),z.delete(e)},t);return z.add(e),e}function De(n,t){const e=setInterval(n,t);return I.add(e),e}function bt(n){clearTimeout(n),z.delete(n)}function Ht(n){clearInterval(n),I.delete(n)}function Fn(){z.forEach(n=>clearTimeout(n)),z.clear(),I.forEach(n=>clearInterval(n)),I.clear()}function Ie(n){const{title:t="Confirm",message:e="",confirmText:s="Confirm",cancelText:a="Cancel",confirmStyle:i="danger",onConfirm:o=null,onCancel:r=null}=n,d=g("div","modal-overlay");d.style.cssText="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;";const l=g("div","modal-dialog");l.style.cssText="background: #1a1a1a; padding: 30px; border-radius: 12px; text-align: center; max-width: 300px;";const c=g("h3","",{textContent:t});c.style.cssText="color: white; margin: 0 0 15px 0; font-size: 18px;";const h=g("p","",{textContent:e});h.style.cssText="color: #aaa; margin: 0 0 25px 0; font-size: 14px;";const _=g("div","modal-buttons");_.style.cssText="display: flex; gap: 15px; justify-content: center;";const u=g("button","",{textContent:a});u.style.cssText="padding: 10px 25px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;";const f=g("button","",{textContent:s}),m=i==="danger"?"#c92231":"#1a73e8";f.style.cssText=`padding: 10px 25px; background: ${m}; color: white; border: none; border-radius: 6px; cursor: pointer;`;const p=()=>d.remove();return u.addEventListener("click",()=>{p(),r&&r()}),f.addEventListener("click",()=>D(null,null,function*(){if(o){f.disabled=!0,f.style.opacity="0.7";const x=f.textContent;f.textContent="Please wait...";try{yield o()}finally{p()}}else p()})),d.addEventListener("click",x=>{x.target===d&&(p(),r&&r())}),_.appendChild(u),_.appendChild(f),l.appendChild(c),l.appendChild(h),l.appendChild(_),d.appendChild(l),document.body.appendChild(d),{close:p}}const jt={fileRow:(n,t)=>{const e=n.is_dir?"\u{1F4C1}":n.name.endsWith(".ts")?"\u{1F3AC}":"\u{1F4C4}",s=`${t}/${n.name}`.replace("//","/"),a=n.name.endsWith(".ts")?`<a href="/api/play?file=${encodeURIComponent(s)}" target="_blank" class="play-button">\u25B6</a>`:"",i=n.is_dir?`<a href="#" data-path="${s}">${n.name}</a>`:`<a href="/download/${encodeURIComponent(s.startsWith("/")?s.substring(1):s)}" target="_blank" download="${n.name}">${n.name}</a>`;return`
            <tr>
                <td><span class="file-icon">${e}</span>${a}</td>
                <td>${i}</td>
                <td>${n.mtime}</td>
                <td class="file-size" style="text-align:right;">${n.is_dir?"-":xt(n.size)}</td>
            </tr>
        `},breadcrumb:n=>{const t=n.split("/").filter(Boolean);let e="";const s=['<a href="#" data-path="/">root</a>'];return t.forEach((a,i)=>{e+="/"+a,i===t.length-1?s.push(a):s.push(`<a href="#" data-path="${e}">${a}</a>`)}),s.join(" / ")}},Pe={sections:[{title:"Visual",settings:[{id:"HudModeEnabled",type:"toggle",label:"Heads-up Display (HUD) Mode",description:"Mirror the display for windshield projection.",defaultValue:!1,storage:"local"},{id:"ShowVideoInHud",type:"toggle",label:"Show Video",description:"Show or hide video stream in HUD mode.",defaultValue:!0,storage:"local",indent:!0,dependsOn:"HudModeEnabled"}]}]};function Me(n){var o,r;const t=n.id||n.key,e=(r=(o=n.defaultValue)!=null?o:n.current_value)!=null?r:!1,s=g("label","toggle-switch"),a=g("input","",{type:"checkbox",dataset:{param:t}});n.storage&&(a.dataset.storage=n.storage),e&&(a.checked=!0);const i=g("span","toggle-slider");return s.appendChild(a),s.appendChild(i),s}function ke(n){var _,u,f,m,p,x,y;const t=n.id||n.key,e=n.type==="text_spin_button_item",s=!!n.key,a=g("div","setting-control stepper",{dataset:{param:t}});if(e)a.dataset.min=0,a.dataset.max=n.options.length-1,a.dataset.textOptions=JSON.stringify(n.options);else{const S=(u=(_=n.min)!=null?_:n.min_val)!=null?u:n.minVal,E=(m=(f=n.max)!=null?f:n.max_val)!=null?m:n.maxVal;S!==void 0&&(a.dataset.min=S),E!==void 0&&(a.dataset.max=E)}const i=n.step||1,o=g("button","",{dataset:{step:e?-1:-i},textContent:e?"<":"-"});let r,d;const l=(x=(p=n.defaultValue)!=null?p:n.current_value)!=null?x:0;if(e){const S=l||0;r=n.options[S]||n.options[0],d=S}else{const S=String(i).includes(".")||n.type==="double_spin_button_item";d=l;const E=(y=n.min)!=null?y:n.min_val;n.special_value_text&&l===E?r=n.special_value_text:n.suffix?r=(S?l.toFixed(1):l)+n.suffix:r=S?l.toFixed(1):l}const c=g("span","stepper-value",{textContent:r});c.dataset.actualValue=d,e?c.dataset.isTextSpin="true":s&&(c.dataset.suffix=n.suffix||"",c.dataset.specialValueText=n.special_value_text||"",c.dataset.minVal=n.min_val!==void 0?n.min_val:"");const h=g("button","",{dataset:{step:e?1:i},textContent:e?">":"+"});return a.appendChild(o),a.appendChild(c),a.appendChild(h),a}function Oe(n){var a;const t=n.id||n.key,e=(a=n.defaultValue)!=null?a:n.current_value,s=g("div","setting-control btn-group",{dataset:{param:t}});return n.storage&&(s.dataset.storage=n.storage),n.options.forEach(i=>{var l,c;const o=(l=i.value)!=null?l:i,r=(c=i.text)!=null?c:i,d=g("button","",{dataset:{value:o},textContent:r});o===e&&d.classList.add("active"),s.appendChild(d)}),s}function $e(n){const t=n.id||n.key;return g("input","text-input",{type:"text",placeholder:n.placeholder||"",dataset:{param:t}})}function Fe(n){var h;const t=n.id||n.key,e=!!n.key,s=n.dependsOn||n.initially_enabled_by,a=g("div","setting-item");s&&(a.classList.add("dependent"),a.dataset.dependsOn=n.dependsOn||((h=n.initially_enabled_by)==null?void 0:h.param)),t==="ShowVideoInHud"&&(a.id="show-video-setting");const i=g("div","setting-label"),o=g("p","",{[e?"innerHTML":"textContent"]:n.label||n.title}),r=g("span","",{[e?"innerHTML":"textContent"]:n.description});i.appendChild(o),i.appendChild(r);const d=g("div","setting-control");let l;switch(n.type){case"toggle":case"toggle_item":l=Me(n),d.appendChild(l);break;case"stepper":case"spin_button_item":case"double_spin_button_item":case"text_spin_button_item":return l=ke(n),a.appendChild(i),a.appendChild(l),a;case"btn-group":return l=Oe(n),a.appendChild(i),a.appendChild(l),a;case"text-input":l=$e(n),d.appendChild(l);break}return a.appendChild(i),a.appendChild(d),a}function it(n,t){document.querySelectorAll(`.setting-item[data-depends-on="${n}"]`).forEach(s=>{s.style.display=t?"":"none"})}function wt(n,t,e,s){const a=n.querySelector('button[data-step*="-"]'),i=n.querySelector('button:not([data-step*="-"])');a&&(t<=e?(a.disabled=!0,a.style.opacity="0.3",a.style.cursor="not-allowed"):(a.disabled=!1,a.style.opacity="",a.style.cursor="pointer")),i&&(t>=s?(i.disabled=!0,i.style.opacity="0.3",i.style.cursor="not-allowed"):(i.disabled=!1,i.style.opacity="",i.style.cursor="pointer"))}function Be(n,t){const e=n.id||n.key;return t.some(s=>{var a;return s.dependsOn===e||((a=s.initially_enabled_by)==null?void 0:a.param)===e})}function Wt(n,t,e={}){const{clearContainer:s=!0}=e;s&&(t.innerHTML=""),(n.sections||n).forEach(i=>{const o=g("div","settings-category"),r=g("h2","",{textContent:i.title});o.appendChild(r);const d=i.settings;let l=null,c=null;d.forEach(h=>{var x;const _=Fe(h),u=h.id||h.key,f=h.dependsOn||h.initially_enabled_by,m=h.dependsOn||((x=h.initially_enabled_by)==null?void 0:x.param),p=_.querySelector(".stepper");if(p){const y=p.querySelector(".stepper-value"),S=parseFloat(y.dataset.actualValue),E=p.dataset.min!==void 0?parseFloat(p.dataset.min):-1/0,et=p.dataset.max!==void 0?parseFloat(p.dataset.max):1/0;wt(p,S,E,et)}if(f&&l&&m===c)_.style.display="none",l.appendChild(_);else if(Be(h,d))l=g("div","setting-group"),l.dataset.parentKey=u,c=u,l.appendChild(_),o.appendChild(l);else if(f){const y=o.querySelector(`.setting-group[data-parent-key="${m}"]`);y?(_.style.display="none",y.appendChild(_)):(_.style.display="none",o.appendChild(_)),l=null,c=null}else o.appendChild(_),l=null,c=null}),t.appendChild(o)})}function vt(n=!0){const t={},e=n?'[data-param][data-storage="local"]':'[data-param]:not([data-storage="local"])';return document.querySelectorAll(e).forEach(s=>{const a=s.dataset.param;s.matches('input[type="checkbox"]')?t[a]=s.checked:s.matches(".stepper")?t[a]=parseFloat(s.querySelector(".stepper-value").textContent):s.matches(".btn-group")?t[a]=s.querySelector("button.active").dataset.value:s.matches(".text-input")&&(t[a]=s.value)}),t}function ot(n,t){try{let e=JSON.parse(localStorage.getItem("dashySettings"))||{};e[n]=t,localStorage.setItem("dashySettings",JSON.stringify(e)),qt(n,t)}catch(e){console.error("Error saving local setting:",e)}}function qt(n,t){w.set(`ui.${n.charAt(0).toLowerCase()+n.slice(1)}`,t),it(n,t)}function Ve(){try{const n=JSON.parse(localStorage.getItem("dashySettings"))||{};for(const[t,e]of Object.entries(n)){const s=document.querySelector(`[data-param="${t}"][data-storage="local"]`);if(s)if(s.matches('input[type="checkbox"]'))s.checked=e;else if(s.matches(".stepper"))s.querySelector(".stepper-value").textContent=e;else if(s.matches(".btn-group")){s.querySelectorAll("button").forEach(i=>i.classList.remove("active"));const a=s.querySelector(`[data-value="${e}"]`);a&&a.classList.add("active")}else s.matches(".text-input")&&(s.value=e);qt(t,e)}}catch(n){console.error("Error loading local settings:",n)}}function ze(n){w.subscribe("ui.theme",t=>{}),w.subscribe("ui.hudModeEnabled",t=>{t?n.classList.add("hud-mode"):(n.classList.remove("hud-mode"),n.style.display=""),it("HudModeEnabled",t),Ut(n)}),w.subscribe("ui.showVideoInHud",t=>{Ut(n)}),w.subscribe("ui.navBarVisible",t=>{j.emit("nav:visibility",t)}),w.subscribe("ui.currentPage",t=>{j.emit("page:change",t)})}function Ut(n){const t=w.get("ui.hudModeEnabled"),e=w.get("ui.showVideoInHud"),s=document.getElementById("uiCanvas");t&&!e?(n.style.display="none",s&&(s.style.pointerEvents="auto")):(n.style.display="",s&&(s.style.pointerEvents=""))}const Xt={},Yt={};function Kt(n,t){const e=/^value\s*(===?|!==?|>=?|<=?)\s*(-?\d+(?:\.\d+)?|true|false)$/,s=n.trim();if(!e.test(s))return console.warn("Unsafe condition pattern rejected:",n),!1;try{return new Function("value",`return ${s}`)(t)}catch(a){return console.error("Error evaluating condition:",a),!1}}function yt(n,t){const e=Xt[n];e&&e.forEach(a=>{const i=a.target,o=a.action,r=a.condition;if(o==="set_enabled"&&r){const d=Kt(r,t);it(n,d)}});const s=t===!0||t===1||t>0;it(n,s)}const rt={};function Ct(n,t,e=!1){return D(this,null,function*(){e?(rt[n]&&clearTimeout(rt[n]),rt[n]=P(()=>{Jt(n,t),delete rt[n]},500)):Jt(n,t)})}function Jt(n,t){return D(this,null,function*(){try{const e=window.location.hostname,s=yield fetch(`http://${e}:5088/api/settings/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({[n]:t})}),a=yield s.json();if(!s.ok)throw new Error(a.message||"Save failed")}catch(e){console.error(`Failed to save setting ${n}:`,e)}})}function Ne(n){return D(this,null,function*(){try{const t=yield fetch(`http://${n}:5088/api/settings/config`,{method:"GET",signal:AbortSignal.timeout(5e3)});if(!t.ok){console.warn("Failed to fetch remote settings:",t.statusText);return}const e=yield t.json();if(!e.settings||!Array.isArray(e.settings)){console.warn("Invalid settings response format");return}const s=document.getElementById("local-settings-content");if(!s){console.warn("No settings container found");return}e.settings.forEach(i=>{i.settings.forEach(o=>{o.on_change&&(Xt[o.key]=o.on_change),o.initially_enabled_by&&(Yt[o.key]=o.initially_enabled_by)})});const a=g("div","settings-separator");a.innerHTML='<hr style="border-color: #333; margin: 20px 0;">',s.appendChild(a),Wt(e.settings,s,{clearContainer:!1,isRemote:!0}),qe(),Ge(s)}catch(t){console.warn("Error fetching remote settings:",t.message)}})}function Ge(n){const t=g("div","settings-category reboot-section");t.style.marginTop="30px",t.style.paddingTop="20px",t.style.borderTop="1px solid #333";const e=g("button","reboot-btn",{textContent:"Reboot Device"});e.style.cssText="width: 100%; padding: 15px; background: #c92231; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;",e.addEventListener("click",()=>{Ie({title:"Reboot Device?",message:"This will reboot the device to apply changes.",confirmText:"Reboot",cancelText:"Cancel",confirmStyle:"danger",onConfirm:()=>D(null,null,function*(){const s=window.location.hostname;yield fetch(`http://${s}:5088/api/settings/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({DoReboot:!0})})})})}),t.appendChild(e),n.appendChild(t)}function He(n){return D(this,null,function*(){const t=window.location.hostname;try{const e=yield fetch(`http://${t}:5088/api/models`,{method:"GET",signal:AbortSignal.timeout(5e3)});if(!e.ok){console.warn("Failed to fetch model list:",e.statusText);return}const s=yield e.json();if(!s.model_list||Object.keys(s.model_list).length===0){console.warn("No models available");return}je(n,s.model_list,s.selected_model)}catch(e){console.warn("Error fetching model list:",e.message)}})}function je(n,t,e){const s=g("div","settings-category model-selector-section"),a=g("h2","",{textContent:"Model Selection"});s.appendChild(a);const i=g("div","setting-item");i.style.flexDirection="column",i.style.alignItems="stretch";const o=g("div","setting-label");o.style.marginBottom="10px";const r=g("p","",{textContent:"Vehicle Model"}),d=g("span","",{textContent:"Select your vehicle model or use AUTO for automatic detection."});o.appendChild(r),o.appendChild(d);const l=g("div","model-selector"),c=g("div","model-selector-current"),h=g("span","current-value",{textContent:e||"[AUTO]"}),_=g("span","change-btn",{textContent:"Change"});c.appendChild(h),c.appendChild(_);const u=g("div","model-selector-dropdown"),f=g("div","model-option auto-option",{textContent:"[AUTO]",dataset:{model:""}});e||f.classList.add("selected"),u.appendChild(f),Object.keys(t).sort().forEach(x=>{const y=g("div","model-brand",{textContent:x});u.appendChild(y),t[x].sort().forEach(E=>{const et=g("div","model-option",{textContent:E,dataset:{model:E}});E===e&&et.classList.add("selected"),u.appendChild(et)})}),l.appendChild(c),l.appendChild(u),i.appendChild(o),i.appendChild(l),s.appendChild(i);const p=n.querySelector(".reboot-section");p?n.insertBefore(s,p):n.appendChild(s),c.addEventListener("click",()=>{u.classList.toggle("open")}),u.addEventListener("click",x=>D(null,null,function*(){const y=x.target.closest(".model-option");if(!y)return;const S=y.dataset.model;u.querySelectorAll(".model-option").forEach(E=>E.classList.remove("selected")),y.classList.add("selected"),h.textContent=S||"[AUTO]",u.classList.remove("open"),yield We(S)})),document.addEventListener("click",x=>{l.contains(x.target)||u.classList.remove("open")})}function We(n){return D(this,null,function*(){const t=window.location.hostname;try{(yield fetch(`http://${t}:5088/api/models/select`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({selected_model:n})})).ok||console.error("Failed to save model selection")}catch(e){console.error("Error saving model selection:",e)}})}function qe(){for(const[n,t]of Object.entries(Yt)){const e=t.param,s=t.condition,a=t.default||0,i=document.querySelector(`[data-param="${e}"]`),o=document.querySelector(`[data-param="${n}"]`);if(i&&o){let r;const d=i.querySelector(".stepper-value");d?r=parseFloat(d.dataset.actualValue):i.matches('input[type="checkbox"]')?r=i.checked?1:0:r=a;const l=Kt(s,r),c=o.closest(".setting-item");c&&(c.style.display=l?"":"none")}}}function Ue(n){Wt(Pe,n)}const St=new Map;function Zt(n="/"){return D(this,null,function*(){const t=document.querySelector("#files-table tbody"),e=document.getElementById("files-breadcrumbs"),s=St.get(n);s&&s.abort();const a=new AbortController;St.set(n,a);try{t.innerHTML='<tr><td colspan="4" style="text-align:center;">Loading...</td></tr>';const i=yield fetch(`/api/files?path=${encodeURIComponent(n)}`,{signal:a.signal});if(!i.ok)throw new Error(`Server error: ${i.statusText}`);const o=yield i.json();Xe(o.path,e),Ye(o.path,o.files,t)}catch(i){if(i.name==="AbortError")return;t.innerHTML=`<tr><td colspan="4" style="text-align:center;color:#e53e3e;">Failed to load files: ${i.message}</td></tr>`,console.error("Fetch files error:",i)}finally{St.delete(n)}})}function Xe(n,t){t.innerHTML="<strong>Path:</strong> "+jt.breadcrumb(n),w.set("files.currentPath",n)}function Ye(n,t,e){w.set("files.items",t);let s="";if(n){const a=n.substring(0,n.lastIndexOf("/"))||"/";s+=`<tr><td><span class="file-icon"></span></td><td><a href="#" data-path="${a}">.. (Parent Directory)</a></td><td></td><td></td></tr>`}t.forEach(a=>{s+=jt.fileRow(a,n)}),e.innerHTML=s}const Qt=10,Et=100,Ke=1/(.5*60),te=[{r:13,g:248,b:122,a:102},{r:114,g:255,b:92,a:89},{r:114,g:255,b:92,a:0}],ee=[{r:242,g:242,b:242,a:102},{r:242,g:242,b:242,a:89},{r:242,g:242,b:242,a:0}];function ne(n,t){const e=[[0,0,0],[0,0,0],[0,0,0]];for(let s=0;s<3;s++)for(let a=0;a<3;a++)e[s][a]=n[s][0]*t[0][a]+n[s][1]*t[1][a]+n[s][2]*t[2][a];return e}function Je(n,t,e,s){const a=n[0][0]*t+n[0][1]*e+n[0][2]*s,i=n[1][0]*t+n[1][1]*e+n[1][2]*s,o=n[2][0]*t+n[2][1]*e+n[2][2]*s;return Math.abs(o)<1e-6?{x:0,y:0,z:0,valid:!1}:{x:a/o,y:i/o,z:o,valid:!0}}function N(n,t,e){return Math.max(t,Math.min(e,n))}function Ze(n){const[t,e,s]=n,a=Math.cos(t),i=Math.sin(t),o=Math.cos(e),r=Math.sin(e),d=Math.cos(s),l=Math.sin(s);return[[d*o,d*r*i-l*a,d*r*a+l*i],[l*o,l*r*i+d*a,l*r*a-d*i],[-r,o*i,o*a]]}const Tt=[[0,-1,0],[0,0,-1],[1,0,0]],lt={tici:{fcam:{intrinsics:[[2648,0,964],[0,2648,604],[0,0,1]],width:1928,height:1208}},mici:{fcam:{intrinsics:[[1141.5,0,672],[0,1141.5,380],[0,0,1]],width:1344,height:760}}};class se{constructor(){this._longitudinal_control=!1,this._experimental_mode=!1,this._blend_factor=1,this._prev_allow_throttle=!0,this._lead_vehicles=[{},{}],this._path_offset_z=1.22,this._use_simple_lines=!0,this._path={raw_points:[],projected_points:[]},this._lane_lines=[{raw_points:[],projected_points:[]},{raw_points:[],projected_points:[]},{raw_points:[],projected_points:[]},{raw_points:[],projected_points:[]}],this._road_edges=[{raw_points:[],projected_points:[]},{raw_points:[],projected_points:[]}],this._acceleration_x=new Float32Array(0),this._maxPoints=200,this._leftPointsBuffer=new Array(this._maxPoints),this._rightPointsBuffer=new Array(this._maxPoints),this._transformCache=new Map,this._transformCacheValid=!1,this._batchTransformEnabled=!0,this._batchLeftX=new Float32Array(this._maxPoints),this._batchLeftY=new Float32Array(this._maxPoints),this._batchLeftZ=new Float32Array(this._maxPoints),this._batchRightX=new Float32Array(this._maxPoints),this._batchRightY=new Float32Array(this._maxPoints),this._batchRightZ=new Float32Array(this._maxPoints),this._maxBatchPoints=2e3,this._batchAllX=new Float32Array(this._maxBatchPoints),this._batchAllY=new Float32Array(this._maxBatchPoints),this._batchAllZ=new Float32Array(this._maxBatchPoints),this._lane_line_probs=new Float32Array(4),this._road_edge_stds=new Float32Array(2),this._gradientCache=new Map,this._gradientCacheMaxSize=50,this._pathCache=new Map,this._pathCacheMaxSize=30,this._lastPathPoints=null,this._lastPathHash=null,this._pathLengthCache=new Map,this._lastPathLengthCacheClear=0,this._framePathLengthCache=new Map,this._lastFrameTime=0,this._path_x_cache=new Float32Array(this._maxPoints),this._path_x_length=0,this._car_space_transform=[[1,0,0],[0,1,0],[0,0,1]],this._transform_dirty=!0,this._clip_region=null,this._rect=null,this._exp_gradient={start:[0,1],end:[0,0],colors:[],stops:[]}}set_transform(t){this._car_space_transform=t,this._transform_dirty=!0,this._transformCache.clear(),this._transformCacheValid=!1,this._gradientCache.clear()}set_simple_lines_mode(t){this._use_simple_lines=t}clear_caches(){this._transformCache.clear(),this._transformCacheValid=!1,this._gradientCache.clear(),this._pathCache.clear(),this._lastPathHash=null}render(t,e,s){if(this._rect=t,this.ctx=s,s.lineCap="round",s.lineJoin="round",!e.liveCalibration||!e.modelV2)return;this._clip_region={x:t.x,y:t.y,width:t.width,height:t.height},e.selfdriveState&&(this._experimental_mode=e.selfdriveState.experimentalMode||!1);const a=e.liveCalibration;a&&a.height&&a.height.length>0&&(this._path_offset_z=a.height[0]),e.updated&&e.updated.carParams?this._longitudinal_control=e.carParams.openpilotLongitudinalControl||!1:(!e.seen||!e.seen.carParams)&&(this._longitudinal_control=!0);const i=e.modelV2;if(!i)return;const o=e.valid&&e.valid.radarState?e.radarState:null,r=o?o.leadOne:null,d=this._longitudinal_control&&o!==null,l=e.updated&&e.updated.modelV2,c=e.updated&&e.updated.radarState;if(l||c||this._transform_dirty){if(l&&this._update_raw_points(i),this._path_x_length===0)return;this._update_model(r),d&&this._update_leads(o),this._transform_dirty=!1}e.selfdriveState&&(e.selfdriveState.enabled||e.selfdriveState.activeOverride)&&(this._draw_lane_lines(),this._draw_path(e)),d&&o&&this._draw_lead_indicator()}_update_raw_points(t){if(t.position){this._path.raw_points.length=0;const a=t.position.x.length;for(let i=0;i<a;i++)this._path.raw_points.push([t.position.x[i],t.position.y[i],t.position.z[i]]),this._path_x_cache[i]=t.position.x[i];this._path_x_length=a}if(this._transformCache.size>200&&Array.from(this._transformCache.keys()).slice(0,100).forEach(i=>this._transformCache.delete(i)),this._pathCache.size>this._pathCacheMaxSize){const a=Array.from(this._pathCache.entries()).slice(-5);this._pathCache.clear(),a.forEach(([i,o])=>this._pathCache.set(i,o))}t.laneLines&&t.laneLines.forEach((a,i)=>{this._lane_lines[i].raw_points.length=0;for(let o=0;o<a.x.length;o++)this._lane_lines[i].raw_points.push([a.x[o],a.y[o],a.z[o]])}),t.roadEdges&&t.roadEdges.forEach((a,i)=>{this._road_edges[i].raw_points.length=0;for(let o=0;o<a.x.length;o++)this._road_edges[i].raw_points.push([a.x[o],a.y[o],a.z[o]])});const e=t.laneLineProbs||[0,0,0,0];for(let a=0;a<4;a++)this._lane_line_probs[a]=e[a]||0;const s=t.roadEdgeStds||[1,1];for(let a=0;a<2;a++)this._road_edge_stds[a]=s[a]||1;t.acceleration&&t.acceleration.x&&(this._acceleration_x.length!==t.acceleration.x.length&&(this._acceleration_x=new Float32Array(t.acceleration.x.length)),this._acceleration_x.set(t.acceleration.x))}_update_model(t){let e=N(this._path_x_cache[this._path_x_length-1],Qt,Et);const s=this._get_path_length_idx(this._lane_lines[0].raw_points.map(a=>a[0]),e);this._batch_update_lines(s,t),this._update_experimental_gradient(this._rect.height)}_batch_update_lines(t,e){const s=[];for(let o=0;o<this._lane_lines.length;o++)s.push({line:this._lane_lines[o],raw_points:this._lane_lines[o].raw_points,y_offset:.025*this._lane_line_probs[o],z_offset:0,max_idx:t,allow_invert:!0});for(let o=0;o<this._road_edges.length;o++)s.push({line:this._road_edges[o],raw_points:this._road_edges[o].raw_points,y_offset:.025,z_offset:0,max_idx:t,allow_invert:!0});let a=N(this._path_x_cache[this._path_x_length-1],Qt,Et);if(e&&e.status){const o=e.dRel*2;a=N(o-Math.min(o*.35,10),0,a)}const i=this._get_path_length_idx_cached(a);s.push({line:this._path,raw_points:this._path.raw_points,y_offset:.9,z_offset:this._path_offset_z,max_idx:i,allow_invert:!1}),this._batch_transform_all_lines(s)}_batch_transform_all_lines(t){let e=0;const s=[];for(const l of t){const c=l.raw_points.slice(0,l.max_idx+1).filter(h=>h[0]>=0);c.length>0&&(s.push(Gt(Nt({},l),{points:c,startIdx:e,numPoints:c.length})),e+=c.length*2)}if(e===0)return;e>this._maxBatchPoints&&(this._maxBatchPoints=e,this._batchAllX=new Float32Array(e),this._batchAllY=new Float32Array(e),this._batchAllZ=new Float32Array(e));const a=this._batchAllX,i=this._batchAllY,o=this._batchAllZ;let r=0;for(const l of s)for(let c=0;c<l.numPoints;c++){const h=l.points[c];a[r]=h[0],i[r]=h[1]-l.y_offset,o[r]=h[2]+l.z_offset,r++,a[r]=h[0],i[r]=h[1]+l.y_offset,o[r]=h[2]+l.z_offset,r++}const d=this._batch_transform(a,i,o,e);for(const l of s){const c=[],h=[],_=[];for(let u=0;u<l.numPoints;u++){const f=l.startIdx+u*2,m=f+1,p=d.points[f],x=d.points[m];p.valid&&x.valid&&Math.abs(p.x)<1e4&&Math.abs(p.y)<1e4&&Math.abs(x.x)<1e4&&Math.abs(x.y)<1e4&&(h.push([p.x,p.y]),_.push([x.x,x.y]))}if(!l.allow_invert&&h.length>1){const u=[],f=[];let m=1/0;for(let p=0;p<h.length;p++)h[p][1]<=m&&(m=h[p][1],u.push(h[p]),f.push(_[p]));h.length=0,_.length=0,h.push(...u),_.push(...f)}h.forEach(u=>c.push(u));for(let u=_.length-1;u>=0;u--)c.push(_[u]);l.line.projected_points=c}}_update_leads(t){this._lead_vehicles=[{},{}];const e=[t.leadOne,t.leadTwo],s=[],a={x:[],y:[],z:[]};for(let o=0;o<e.length;o++){const r=e[o];if(r&&r.status){const d=r.dRel,l=r.yRel,c=r.vRel,h=this._get_path_length_idx_cached(d);let _=0;h<this._path.raw_points.length&&(_=this._path.raw_points[h][2]),s.push({i:o,d_rel:d,v_rel:c}),a.x.push(d),a.y.push(-l),a.z.push(_+this._path_offset_z)}}if(s.length===0)return;const i=this._batch_transform(new Float32Array(a.x),new Float32Array(a.y),new Float32Array(a.z),s.length);for(let o=0;o<s.length;o++){const r=s[o],d=i.points[o];if(d.valid){const l=[d.x,d.y];this._lead_vehicles[r.i]=this._update_lead_vehicle(r.d_rel,r.v_rel,l,this._rect)}}}_map_to_screen(t,e,s){const a=Je(this._car_space_transform,t,e,s);return a.valid?[a.x,a.y]:null}_batch_transform(t,e,s,a){const i=new Array(a),o=this._car_space_transform;let r=0;const d=o[0][0],l=o[0][1],c=o[0][2],h=o[1][0],_=o[1][1],u=o[1][2],f=o[2][0],m=o[2][1],p=o[2][2];for(let x=0;x<a;x++){const y=t[x],S=e[x],E=s[x],et=d*y+l*S+c*E,In=h*y+_*S+u*E,Te=f*y+m*S+p*E;if(Math.abs(Te)>=1e-6){const Ae=1/Te;i[x]={x:et*Ae,y:In*Ae,valid:!0},r++}else i[x]={x:0,y:0,valid:!1}}return{points:i,validCount:r}}_get_path_length_idx(t,e){if(t.length===0)return 0;const s=`${t.length}_${Math.round(e*100)}`,a=Date.now();if(a!==this._lastFrameTime&&(this._framePathLengthCache.clear(),this._lastFrameTime=a),this._framePathLengthCache.has(s))return this._framePathLengthCache.get(s);if(this._pathLengthCache.has(s)){const o=this._pathLengthCache.get(s);return this._framePathLengthCache.set(s,o),o}a-this._lastPathLengthCacheClear>1e4&&(this._pathLengthCache.clear(),this._lastPathLengthCacheClear=a);let i=0;for(let o=0;o<t.length&&t[o]<=e;o++)i=o;return this._pathLengthCache.set(s,i),this._framePathLengthCache.set(s,i),i}_get_path_length_idx_cached(t){if(this._path_x_length===0)return 0;const e=`path_${this._path_x_length}_${Math.round(t*100)}`;if(this._framePathLengthCache.has(e))return this._framePathLengthCache.get(e);let s=0;for(let a=0;a<this._path_x_length&&this._path_x_cache[a]<=t;a++)s=a;return this._framePathLengthCache.set(e,s),s}_draw_lane_lines(){this._use_simple_lines?this._batch_draw_all_lines():(this._lane_lines.forEach((t,e)=>{if(t.projected_points.length===0)return;const s=N(this._lane_line_probs[e],0,.7);this._draw_polygon(t.projected_points,`rgba(255, 255, 255, ${s})`)}),this._road_edges.forEach((t,e)=>{if(t.projected_points.length===0)return;const s=N(1-this._road_edge_stds[e],0,1);this._draw_polygon(t.projected_points,`rgba(255, 0, 0, ${s})`)}))}_batch_draw_all_lines(){const t=[];if(this._lane_lines.forEach((_,u)=>{if(_.raw_points.length<2)return;const f=this._lane_line_probs[u];if(f<.1)return;const m=N(f,0,.7);t.push({points:_.raw_points,color:`rgba(255, 255, 255, ${m})`,lineWidth:4})}),this._road_edges.forEach((_,u)=>{if(_.raw_points.length<2)return;const f=this._road_edge_stds[u];if(f>.9)return;const m=N(1-f,0,1);t.push({points:_.raw_points,color:`rgba(255, 0, 0, ${m})`,lineWidth:4})}),t.length===0)return;let e=0;const s=[],a=Et;for(const _ of t){const u=[];for(let f=0;f<_.points.length;f++){const m=_.points[f];m[0]>=0&&m[0]<=a&&u.push(f)}u.length>=2&&(s.push(Gt(Nt({},_),{validIndices:u,startIdx:e,numPoints:u.length})),e+=u.length)}if(e===0)return;e>this._maxBatchPoints&&(this._maxBatchPoints=e,this._batchAllX=new Float32Array(e),this._batchAllY=new Float32Array(e),this._batchAllZ=new Float32Array(e));const i=this._batchAllX,o=this._batchAllY,r=this._batchAllZ;let d=0;for(const _ of s)for(const u of _.validIndices){const f=_.points[u];i[d]=f[0],o[d]=f[1],r[d]=f[2],d++}const l=this._batch_transform(i,o,r,e),c=this.ctx,h=5e3;for(const _ of s){c.strokeStyle=_.color,c.lineWidth=_.lineWidth,c.beginPath();let u=!1;for(let f=0;f<_.numPoints;f++){const m=_.startIdx+f,p=l.points[m];p.valid&&Math.abs(p.x)<h&&Math.abs(p.y)<h?u?f>0&&_.validIndices[f]-_.validIndices[f-1]===1?c.lineTo(p.x,p.y):(c.stroke(),c.beginPath(),c.moveTo(p.x,p.y)):(c.moveTo(p.x,p.y),u=!0):u&&(c.stroke(),c.beginPath(),u=!1)}u&&c.stroke()}}_draw_path(t){if(this._path.projected_points.length!==0)if(this._experimental_mode)this._exp_gradient.colors.length>2?this._draw_polygon_gradient(this._path.projected_points,this._exp_gradient):this._draw_polygon(this._path.projected_points,"rgba(255, 255, 255, 0.12)");else{const e=t.longitudinalPlan&&t.longitudinalPlan.allowThrottle||!this._longitudinal_control;e!==this._prev_allow_throttle&&(this._prev_allow_throttle=e,this._blend_factor=Math.max(1-this._blend_factor,0)),this._blend_factor<1&&(this._blend_factor=Math.min(this._blend_factor+Ke,1));const s=e?ee:te,a=e?te:ee,i=this._blend_colors(s,a,this._blend_factor),o={start:[0,1],end:[0,0],colors:i,stops:[0,.5,1]};this._draw_polygon_gradient(this._path.projected_points,o)}}_draw_polygon(t,e){if(t.length<3)return;const s=this.ctx;s.fillStyle=e;const a=this._getCachedPath2D(t);s.fill(a)}_getCachedPath2D(t){const e=this._generatePointsHash(t);if(this._pathCache.has(e))return this._pathCache.get(e);const s=new Path2D;s.moveTo(t[0][0],t[0][1]);for(let a=1;a<t.length;a++)s.lineTo(t[a][0],t[a][1]);if(s.closePath(),this._pathCache.set(e,s),this._pathCache.size>this._pathCacheMaxSize){const a=this._pathCache.keys().next().value;this._pathCache.delete(a)}return s}_generatePointsHash(t){if(t.length<3)return"empty";const e=t[0],s=t[Math.floor(t.length/2)],a=t[t.length-1],i=o=>Math.round(o*10)/10;return`${t.length}:${i(e[0])},${i(e[1])}:${i(s[0])},${i(s[1])}:${i(a[0])},${i(a[1])}`}_draw_polygon_gradient(t,e){if(t.length<3)return;const s=this.ctx,a=this._rect,i=e.start[0]*a.width+a.x,o=e.start[1]*a.height+a.y,r=e.end[0]*a.width+a.x,d=e.end[1]*a.height+a.y,l=this._getCachedGradient(s,i,o,r,d,e),c=this._getCachedPath2D(t);s.fillStyle=l,s.fill(c)}_getCachedGradient(t,e,s,a,i,o){const r=Math.round(e),d=Math.round(s),l=Math.round(a),c=Math.round(i);let h=`${r},${d},${l},${c}:`;const _=o.colors;for(let m=0;m<_.length;m++){const p=_[m];h+=`${p.r},${p.g},${p.b},${p.a}|`}const u=o.stops;for(let m=0;m<u.length;m++)h+=u[m],m<u.length-1&&(h+=",");if(this._gradientCache.has(h))return this._gradientCache.get(h);const f=t.createLinearGradient(e,s,a,i);for(let m=0;m<o.stops.length;m++){const p=o.colors[m];f.addColorStop(o.stops[m],`rgba(${p.r}, ${p.g}, ${p.b}, ${p.a/255})`)}if(this._gradientCache.set(h,f),this._gradientCache.size>this._gradientCacheMaxSize){const m=this._gradientCache.keys().next().value;this._gradientCache.delete(m)}return f}_blend_colors(t,e,s){if(s>=1)return e;if(s<=0)return t;const a=1-s;return t.map((i,o)=>{const r=e[o];return{r:Math.round(a*i.r+s*r.r),g:Math.round(a*i.g+s*r.g),b:Math.round(a*i.b+s*r.b),a:Math.round(a*i.a+s*r.a)}})}_update_experimental_gradient(t){this._exp_gradient.colors=[],this._exp_gradient.stops=[]}_update_lead_vehicle(t,e,s,a){const r=N(750/(t/3+30),15,30)*1.57*1,d=N(s[0],0,a.width-r/2),l=Math.min(s[1],a.height-r*.6),c=r/5,h=r/10;let _=0;return t<40&&(_=255*(1-t/40),e<0&&(_+=255*(-1*(e/10))),_=Math.min(_,255)),{glow:[[d+r*1.35+c,l+r+h],[d,l-h],[d-r*1.35-c,l+r+h]],chevron:[[d+r*1.25,l+r],[d,l],[d-r*1.25,l+r]],fill_alpha:_}}_draw_lead_indicator(){this._lead_vehicles.forEach(t=>{!t.glow||!t.chevron||(this._draw_triangle_fan(t.glow,"rgba(218, 202, 37, 1)"),this._draw_triangle_fan(t.chevron,`rgba(201, 34, 49, ${t.fill_alpha/255})`))})}_draw_triangle_fan(t,e){if(t.length<3)return;const s=this.ctx;s.fillStyle=e;const a=t[0],i=new Path2D;for(let o=1;o<t.length-1;o++)i.moveTo(a[0],a[1]),i.lineTo(t[o][0],t[o][1]),i.lineTo(t[o+1][0],t[o+1][1]),i.closePath();s.fill(i)}}window.ModelRenderer=se;const At=255,Qe=.621371,tn="\u2013",M={header_height:150,border_size:15,button_size:96,set_speed_width_metric:100,set_speed_width_imperial:86,set_speed_height:102},K={current_speed:88,speed_unit:33,max_speed:20,set_speed:45},k={white:"rgba(255, 255, 255, 1)",disengaged:"rgba(145, 155, 149, 1)",override:"rgba(145, 155, 149, 1)",engaged:"rgba(128, 216, 166, 1)",disengaged_bg:"rgba(0, 0, 0, 0.6)",override_bg:"rgba(145, 155, 149, 0.8)",engaged_bg:"rgba(128, 216, 166, 0.8)",grey:"rgba(166, 166, 166, 1)",dark_grey:"rgba(114, 114, 114, 1)",black_translucent:"rgba(0, 0, 0, 0.65)",white_translucent:"rgba(255, 255, 255, 0.78)",border_translucent:"rgba(255, 255, 255, 0.29)",header_gradient_start:"rgba(0, 0, 0, 0.45)",header_gradient_end:"rgba(0, 0, 0, 0)"},J={DISENGAGED:"DISENGAGED",OVERRIDE:"OVERRIDE",ENGAGED:"ENGAGED"};class ae{constructor(){this.is_cruise_set=!1,this.is_cruise_available=!1,this.set_speed=At,this.speed=0,this.v_ego_cluster_seen=!1,this._click_callback=null,this._gradientCache=null,this._gradientRect=null,this._offscreenCanvas=null,this._offscreenCtx=null,this._cachedState={is_cruise_set:null,is_cruise_available:null,set_speed:null,speed:null,ui_status:null,rect:null}}set_callbacks(t=null){this._click_callback=t}render(t,e,s){if(!t||t.width<=0||t.height<=0)return!1;if(this.ctx=s,this._sm=e,this._update_state(e),this._needsRedraw(t)){this._ensureOffscreenCanvas(t);const i=this.ctx;this.ctx=this._offscreenCtx,this._offscreenCtx.clearRect(0,0,t.width,t.height),this._draw_header_gradient(t),this.is_cruise_available&&this._draw_set_speed(t),this._draw_current_speed(t),this.ctx=i,this._updateCachedState(t)}return this._offscreenCanvas&&this._offscreenCanvas.width>0&&this._offscreenCanvas.height>0&&s.drawImage(this._offscreenCanvas,0,0),this.handle_mouse_event(t)}_needsRedraw(t){if(!this._cachedState.rect||this._cachedState.rect.width!==t.width||this._cachedState.rect.height!==t.height)return!0;const e=this._get_ui_status();return this._cachedState.is_cruise_set!==this.is_cruise_set||this._cachedState.is_cruise_available!==this.is_cruise_available||Math.round(this._cachedState.set_speed||0)!==Math.round(this.set_speed)||Math.round(this._cachedState.speed||0)!==Math.round(this.speed)||this._cachedState.ui_status!==e}_updateCachedState(t){this._cachedState={is_cruise_set:this.is_cruise_set,is_cruise_available:this.is_cruise_available,set_speed:this.set_speed,speed:this.speed,ui_status:this._get_ui_status(),rect:{width:t.width,height:t.height}}}_ensureOffscreenCanvas(t){(!this._offscreenCanvas||this._offscreenCanvas.width!==t.width||this._offscreenCanvas.height!==t.height)&&(this._offscreenCanvas=document.createElement("canvas"),this._offscreenCanvas.width=t.width,this._offscreenCanvas.height=t.height,this._offscreenCtx=this._offscreenCanvas.getContext("2d"),this._gradientCache=null,this._gradientRect=null)}_update_state(t){if(!t.carState||!t.controlsState){this.is_cruise_set=!1,this.set_speed=At,this.speed=0;return}const e=t.controlsState,s=t.carState,a=s.vCruiseCluster||0;this.set_speed=a===0?e.vCruiseDEPRECATED||0:a,this.is_cruise_set=this.set_speed>0&&this.set_speed<At,this.is_cruise_available=this.set_speed!==-1,this.is_cruise_set&&!O.is_metric&&(this.set_speed*=Qe);const i=s.vEgoCluster||0;this.v_ego_cluster_seen=this.v_ego_cluster_seen||i!==0;const o=this.v_ego_cluster_seen?i:s.vEgo||0,r=O.is_metric?3.6:2.236936;this.speed=Math.max(0,o*r)}_draw_header_gradient(t){(!this._gradientCache||!this._gradientRect||this._gradientRect.width!==t.width||this._gradientRect.height!==t.height)&&(this._gradientCache=this.ctx.createLinearGradient(t.x,t.y,t.x,t.y+M.header_height),this._gradientCache.addColorStop(0,k.header_gradient_start),this._gradientCache.addColorStop(1,k.header_gradient_end),this._gradientRect={width:t.width,height:t.height}),this.ctx.fillStyle=this._gradientCache,this.ctx.fillRect(t.x,t.y,t.width,M.header_height)}_draw_set_speed(t){const e=O.is_metric?M.set_speed_width_metric:M.set_speed_width_imperial,s=t.x+30+(M.set_speed_width_imperial-e)/2,a=t.y+22;this.ctx.fillStyle=k.black_translucent,this._draw_rounded_rect(s,a,e,M.set_speed_height,10),this.ctx.strokeStyle=k.border_translucent,this.ctx.lineWidth=3,this._stroke_rounded_rect(s,a,e,M.set_speed_height,10);let i=k.grey,o=k.dark_grey;if(this.is_cruise_set){o=k.white;const d=this._get_ui_status();d===J.ENGAGED?i=k.engaged:d===J.OVERRIDE?i=k.override:i=k.disengaged}this.ctx.fillStyle=i,this.ctx.font=`600 ${K.max_speed}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("MAX",s+e/2,a+23);const r=this.is_cruise_set?Math.round(this.set_speed).toString():tn;this.ctx.fillStyle=o,this.ctx.font=`bold ${K.set_speed}px Arial`,this.ctx.fillText(r,s+e/2,a+61)}_draw_current_speed(t){const e=Math.round(this.speed).toString();this.ctx.fillStyle=k.white,this.ctx.font=`bold ${K.current_speed}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(e,t.x+t.width/2,t.y+22+K.current_speed/2);const s=O.is_metric?"km/h":"mph";this.ctx.fillStyle=k.white_translucent,this.ctx.font=`500 ${K.speed_unit}px Arial`,this.ctx.fillText(s,t.x+t.width/2,t.y+22+K.current_speed+15)}handle_mouse_event(t){if(!this._click_callback)return!1;const e=t.x+t.width-M.border_size-M.button_size,s=t.y+M.border_size,a={x:e,y:s,width:M.button_size,height:M.button_size};return!1}_get_ui_status(){const t=this._sm&&this._sm.selfdriveState;return t?t.enabled?J.ENGAGED:t.activeOverride?J.OVERRIDE:J.DISENGAGED:J.DISENGAGED}_draw_rounded_rect(t,e,s,a,i){this.ctx.beginPath(),this.ctx.moveTo(t+i,e),this.ctx.arcTo(t+s,e,t+s,e+a,i),this.ctx.arcTo(t+s,e+a,t,e+a,i),this.ctx.arcTo(t,e+a,t,e,i),this.ctx.arcTo(t,e,t+s,e,i),this.ctx.closePath(),this.ctx.fill()}_stroke_rounded_rect(t,e,s,a,i){this.ctx.beginPath(),this.ctx.moveTo(t+i,e),this.ctx.arcTo(t+s,e,t+s,e+a,i),this.ctx.arcTo(t+s,e+a,t,e+a,i),this.ctx.arcTo(t,e+a,t,e,i),this.ctx.arcTo(t,e,t+s,e,i),this.ctx.closePath(),this.ctx.stroke()}}window.HudRenderer=ae;const Bn=27,ct=40,Vn=30,zn=20,en=36,nn=36,sn=24,an=66,on=78,rn=48,ie=5,ln=10,W={none:"none",small:"small",mid:"mid",full:"full"},G={normal:"normal",userPrompt:"userPrompt",critical:"critical"},oe={[G.normal]:"rgba(0, 0, 0, 0.92)",[G.userPrompt]:"rgba(254, 140, 52, 0.92)",[G.critical]:"rgba(201, 34, 49, 0.92)"},cn={text1:"openpilot Unavailable",text2:"Waiting to start",size:W.mid,status:G.normal},dn={text1:"TAKE CONTROL IMMEDIATELY",text2:"System Unresponsive",size:W.full,status:G.critical},hn={text1:"System Unresponsive",text2:"Reboot Device",size:W.full,status:G.critical};class re{constructor(){this.started_time=0,this.last_selfdrive_time=0,this._offscreenCanvas=null,this._offscreenCtx=null,this._cachedAlert=null,this._cachedRect=null}render(t,e,s){if(!t||t.width<=0||t.height<=0)return!1;this.ctx=s;const a=this.get_alert(e);if(!a)return this._cachedAlert=null,!1;if(this._needsRedraw(a,t)){this._ensureOffscreenCanvas(t);const o=this.ctx;this.ctx=this._offscreenCtx,this._offscreenCtx.clearRect(0,0,t.width,t.height);const r=this._get_alert_rect(t,a.size);this._draw_background(r,a);const d={x:r.x+ct,y:r.y+ct,width:r.width-2*ct,height:r.height-2*ct};this._draw_text(d,a),this.ctx=o,this._cachedAlert={text1:a.text1,text2:a.text2,size:a.size,status:a.status},this._cachedRect={width:t.width,height:t.height}}return this._offscreenCanvas&&this._offscreenCanvas.width>0&&this._offscreenCanvas.height>0&&s.drawImage(this._offscreenCanvas,0,0),!0}_needsRedraw(t,e){return!this._cachedRect||this._cachedRect.width!==e.width||this._cachedRect.height!==e.height||!this._cachedAlert||this._cachedAlert.text1!==t.text1||this._cachedAlert.text2!==t.text2||this._cachedAlert.size!==t.size||this._cachedAlert.status!==t.status}_ensureOffscreenCanvas(t){(!this._offscreenCanvas||this._offscreenCanvas.width!==t.width||this._offscreenCanvas.height!==t.height)&&(this._offscreenCanvas=document.createElement("canvas"),this._offscreenCanvas.width=t.width,this._offscreenCanvas.height=t.height,this._offscreenCtx=this._offscreenCanvas.getContext("2d"))}get_alert(t){const e=Date.now();if(this.started_time===0&&t.selfdriveState&&(this.started_time=e),!t.selfdriveState)return this.started_time>0&&e-this.started_time>5e3?cn:null;t.updated&&t.updated.selfdriveState&&(this.last_selfdrive_time=e);const s=t.deviceState;if(s&&["tici","tizi","mici"].includes(s.deviceType)&&this.last_selfdrive_time>0){const o=(e-this.last_selfdrive_time)/1e3;if(o>ie){const r=t.selfdriveState;return r&&r.enabled&&o-ie<ln?dn:hn}}const i=t.selfdriveState;return!i||i.alertSize===W.none||!i.alertText1?null:{text1:i.alertText1,text2:i.alertText2||"",size:i.alertSize,status:i.alertStatus||G.normal}}_get_alert_rect(t,e){return e===W.full?t:{x:0,y:t.height*.8,width:t.width,height:t.height*.2}}_draw_background(t,e){const s=oe[e.status]||oe[G.normal];this.ctx.fillStyle=s,this.ctx.fillRect(t.x,t.y,t.width,t.height)}_draw_text(t,e){if(this.ctx.fillStyle="white",this.ctx.textAlign="center",e.size===W.small)this.ctx.font=`bold ${en}px Arial`,this.ctx.textBaseline="middle",this.ctx.fillText(e.text1,t.x+t.width/2,t.y+t.height/2);else if(e.size===W.mid){const s=t.y+t.height/3,a=t.y+t.height*2/3;this.ctx.font=`bold ${nn}px Arial`,this.ctx.textBaseline="bottom",this.ctx.fillText(e.text1,t.x+t.width/2,s),this.ctx.font=`${sn}px Arial`,this.ctx.textBaseline="top",this.ctx.fillText(e.text2,t.x+t.width/2,a)}else{const a=e.text1.length>15?an:on;this.ctx.font=`bold ${a}px Arial`,this.ctx.textBaseline="middle",this.ctx.fillText(e.text1,t.x+t.width/2,t.y+t.height/2),this.ctx.font=`bold ${rn}px Arial`,this.ctx.textBaseline="top",this.ctx.fillText(e.text2,t.x+t.width/2,t.y+t.height*2/3)}}}window.AlertRenderer=re;const q=8,le="calibrated",Nn=[1.22],ce={DISENGAGED:{r:18,g:40,b:57,a:255},OVERRIDE:{r:137,g:146,b:141,a:255},ENGAGED:{r:22,g:127,b:64,a:255}};class Lt{constructor(){this.device_camera=null,this.view_from_calib=[...Tt.map(t=>[...t])],this._last_calib_time=0,this._last_rect_dims={width:0,height:0},this._cached_matrix=null,this._content_rect={x:0,y:0,width:0,height:0},this.model_renderer=new se,this._hud_renderer=new ae,this.alert_renderer=new re,this._click_callback=null}render(t,e,s){this.sm=e,this.ctx=s,this._update_calibration();const a=t.width-2*q,i=t.height-2*q,o=this.device_camera||lt.tici,r=o.fcam.width,d=o.fcam.height,l=a/i,c=r/d;let h=a,_=i,u=t.x+q,f=t.y+q;l>c?(h=i*c,u=t.x+q+(a-h)/2):(_=a/c,f=t.y+q+(i-_)/2),this._content_rect={x:u,y:f,width:h,height:_},this._draw_border(t),s.save(),s.beginPath(),s.rect(Math.floor(t.x),Math.floor(t.y),Math.floor(t.width),Math.floor(t.height)),s.clip(),this._calc_frame_matrix(),this.model_renderer.render(t,e,s),s.restore(),this._hud_renderer.render(t,e,s);const m=this.alert_renderer.render(t,e,s);this._hud_renderer.handle_mouse_event(t)||this._click_callback}set_callbacks(t=null){this._click_callback=t}invalidate_transform_cache(){this._cached_matrix=null,this._last_rect_dims={width:0,height:0},this._last_calib_time=0,this.model_renderer&&this.model_renderer.clear_caches(),this.model_renderer&&(this.model_renderer._transform_dirty=!0)}_update_calibration(){const t=this.sm;if(!this.device_camera&&t.seen&&t.seen.roadCameraState&&t.seen.deviceState&&((t.deviceState?t.deviceState.deviceType:"tici")==="mici"?this.device_camera=lt.mici:this.device_camera=lt.tici),!t.liveCalibration)return;const e=t.liveCalibration;if(!e.rpyCalib||e.rpyCalib.length!==3||e.calStatus!==le){e.calStatus!==le&&(this.view_from_calib=[...Tt.map(a=>[...a])]);return}const s=Ze(e.rpyCalib);this.view_from_calib=ne(Tt,s),this._cached_matrix=null}_calc_frame_matrix(){const t=this.sm.updated&&this.sm.updated.liveCalibration,e=this.sm.recv_frame?this.sm.recv_frame.liveCalibration:Date.now(),s=this.ctx.canvas.width,a=this.ctx.canvas.height,i={width:s,height:a};if(!t&&this._last_calib_time===e&&this._last_rect_dims.width===i.width&&this._last_rect_dims.height===i.height&&this._cached_matrix!==null)return this._cached_matrix;const o=this.device_camera||lt.tici,r=o.fcam.intrinsics,d=o.fcam.width,l=o.fcam.height,c=this.view_from_calib,h=1.1,_=this._content_rect.x,u=this._content_rect.y,f=this._content_rect.width,m=this._content_rect.height,p=r,x=Math.max(s/d,a/l),y=r[0][0]*x*h,S=[[-y,0,s/2],[0,-y,a/2],[0,0,1]],E=ne(S,c);return this.model_renderer.set_transform(E),this._last_calib_time=e,this._last_rect_dims=i,this._cached_matrix=E,this._cached_matrix}_draw_border(t){let e="DISENGAGED";this.sm.selfdriveState&&(this.sm.selfdriveState.enabled?e="ENGAGED":this.sm.selfdriveState.activeOverride&&(e="OVERRIDE"));const s=ce[e]||ce.DISENGAGED;this.ctx.strokeStyle=`rgba(${s.r}, ${s.g}, ${s.b}, ${s.a/255})`,this.ctx.lineWidth=q,this.ctx.strokeRect(t.x,t.y,t.width,t.height)}}window.AugmentedRoadView=Lt;let C=null,dt=null,Rt=!1,de=null,ht=null,$=null,U=null,Dt=0;const It=1e3,he=5e3,_e=2;let B=It,Pt=0,ue=!1;const _n=/\bNaN\b/g,b={modelV2:null,liveCalibration:null,longitudinalPlan:null,radarState:null,selfdriveState:null,deviceState:null,carState:null,carParams:null,controlsState:null,roadCameraState:null,driverStateV2:null,driverMonitoringState:null,recv_frame:{},recv_time:{},updated:{},valid:{},seen:{},frame:0};let fe=0,pe=0,Mt=0,kt=0,Ot=0,_t=0;const O={sm:b,started_frame:0,is_metric:!1,status:"DISENGAGED",engaged:!1},$t={textContent:""},ge={style:{backgroundColor:""}},me=1e3/20;let xe=0,be,we=0,Z=[];const un=500;let ve="",ye="",Q=!0,F=null,L=null,ut=null,Ft=null,Bt=null,X=null,v=null,V=null;function fn(n){Ft=n.hudPage,Bt=n.videoWrapper,X=n.videoPlayer,v=n.uiCanvas,V=v.getContext("2d");let t=null;new ResizeObserver(()=>{t||(t=requestAnimationFrame(()=>{t=null,Vt()}))}).observe(Bt),window.addEventListener("orientationchange",()=>Vt()),document.addEventListener("visibilitychange",()=>{if(document.hidden)Pt=Date.now();else if(Ft.classList.contains("active")){const s=Pt>0?Date.now()-Pt:0;window.animationFrameId||requestAnimationFrame(pt),s>3e3&&(console.log(`Tab was hidden for ${s}ms, forcing WebRTC reconnect`),tt())}})}function Vt(){const{width:n,height:t}=Bt.getBoundingClientRect();n>0&&(v.width!==n||v.height!==t)&&(v.width=n,v.height=t,$&&$.invalidate_transform_cache(),!$&&v.width>0&&v.height>0&&($=new Lt,$.set_callbacks(()=>{b.selfdriveState&&(b.selfdriveState.experimentalMode=!b.selfdriveState.experimentalMode)}),requestAnimationFrame(pt)))}function pn(){!$&&v.width>0&&v.height>0&&($=new Lt,$.set_callbacks(()=>{b.selfdriveState&&(b.selfdriveState.experimentalMode=!b.selfdriveState.experimentalMode)}),requestAnimationFrame(pt))}function Y(n,t){$t.textContent=n;const e={green:"#48bb78",yellow:"#f6e05e",red:"#f56565"};ge.style.backgroundColor=e[t]||e.red,Q=!0,bt(be),be=P(()=>{$t.textContent="",Q=!0},5e3)}const gn={text:"Model data stale",severity:"warning"},mn={text:"Car state stale",severity:"warning"},xn={text:"Selfdrive state stale",severity:"critical"};function bn(){const n=Date.now();return n-we<un||(we=n,Z.length=0,Mt>0&&n-Mt>2e3&&Z.push(gn),kt>0&&n-kt>2e3&&Z.push(mn),Ot>0&&n-Ot>3e3&&Z.push(xn)),Z}function wn(){const n=$t.textContent,t=ge.style.backgroundColor;(n!==ve||t!==ye)&&(Q=!0,ve=n,ye=t);const e=bn();if(e.length>0&&!n){const a=e.find(i=>i.severity==="critical")||e[0];Y(a.text,a.severity==="critical"?"red":"yellow");return}if(n){if((!ut||ut.width!==v.width||ut.height!==v.height)&&(Q=!0,ut={width:v.width,height:v.height}),Q){Q=!1;const s=1.5*8,a=.5*8,i=1.5*8;V.font=`${i}px Arial`;const r=V.measureText(n).width+s*2+6+4,d=i+a*2;(!F||F.width!==r||F.height!==d)&&(F=document.createElement("canvas"),F.width=r,F.height=d,L=F.getContext("2d")),L.clearRect(0,0,r,d);const l=5;L.fillStyle="rgba(0, 0, 0, 0.7)",L.beginPath(),L.roundRect(0,0,r,d,l),L.fill();const c=3,h=s+c,_=d/2;L.fillStyle=t,L.beginPath(),L.arc(h,_,c,0,Math.PI*2),L.fill(),L.fillStyle="white",L.font=`${i}px Arial`,L.textAlign="left",L.textBaseline="middle";const u=h+c+4;L.fillText(n,u,_)}if(F){const s=v.width/2,a=15,i=s-F.width/2,o=v.height-F.height-a;V.drawImage(F,i,o)}}}function vn(n){const t=n.split(`\r
`);let e=-1;const s=[];for(let l=0;l<t.length;l++)if(t[l].startsWith("m=video"))e=l;else if(t[l].includes("H264/90000")){const c=t[l].match(/a=rtpmap:(\d+) H264\/90000/);c&&c[1]&&s.push(c[1])}if(e===-1||s.length===0)return n;const a=[];for(const l of s)for(let c=0;c<t.length;c++)if(t[c].includes(`apt=${l}`)&&t[c].includes("rtx/90000")){const h=t[c].match(/a=rtpmap:(\d+) rtx\/90000/);h&&h[1]&&a.push(h[1])}const i=[...s,...a],o=t[e].split(" "),r=o.slice(3).filter(l=>!i.includes(l)),d=o.slice(0,3).concat(i,r).join(" ");return t[e]=d,t.join(`\r
`)}function ft(){clearTimeout(U),Ht(ht),ht=null,C&&(C.close(),C=null),dt&&(dt.close(),dt=null),$=null,window.animationFrameId&&cancelAnimationFrame(window.animationFrameId)}function tt(){if(ue)return;const n=Ce||window.location.hostname;ft(),B=It,Sn(n),pn()}let nt=null,Ce=null;function yn(){return D(this,null,function*(){const n=window.location.hostname;Ce=n;try{const t=yield fetch(`http://${n}:5088/api/init`,{method:"GET",signal:AbortSignal.timeout(5e3)});if(t.ok){nt=yield t.json(),Rt=nt.is_metric,O.is_metric=Rt,nt.openpilot_longitudinal_control!==void 0&&(b.carParams={openpilotLongitudinalControl:nt.openpilot_longitudinal_control},b.seen.carParams=!0,b.valid.carParams=!0),nt.dp_dev_dashy===!1&&Cn(),Ne(n);const e=document.getElementById("local-settings-content");e&&He(e)}else throw new Error(`Connection failed: ${t.statusText}`)}catch(t){console.error(`Failed to connect to ${n}:`,t)}})}function Cn(){ue=!0;const n=document.getElementById("nav-hud");n&&(n.style.display="none");const t=document.getElementById("hud-page");t&&(t.style.display="none")}function Sn(n){return D(this,null,function*(){Y("Initializing WebRTC...","yellow"),clearTimeout(U),_t=Date.now(),C&&(C.close(),C=null);try{C=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});const t=C.createDataChannel("data");Tn(t),C.ontrack=i=>{i.track.kind==="video"&&(X.srcObject=i.streams[0],Vt(),Y("Video connected","green"),X.onplaying=()=>{clearTimeout(U)})},C.onconnectionstatechange=()=>{C.connectionState==="failed"||C.connectionState==="disconnected"||C.connectionState==="closed"?(console.warn("WebRTC connection state:",C.connectionState),Y(`Connection lost. Retrying in ${B/1e3}s...`,"red"),w.get("ui.currentPage")==="hud"&&(U=P(()=>{tt(),B=Math.min(B*_e,he)},B))):C.connectionState==="connected"&&(Y("WebRTC Connected","green"),clearTimeout(U),B=It)},C.addTransceiver("video",{direction:"recvonly"});const e=yield C.createOffer();e.sdp=vn(e.sdp),yield C.setLocalDescription(e);const s=yield fetch(`http://${n}:5001/stream`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sdp:C.localDescription.sdp,cameras:["road"],bridge_services_in:[],bridge_services_out:["modelV2","liveCalibration","longitudinalPlan","radarState","selfdriveState","deviceState","carState","carParams","controlsState"]})});if(!s.ok){const i=yield s.text();throw new Error(`HTTP Error! Status: ${s.status}, Message: ${i}`)}const a=yield s.json();yield C.setRemoteDescription(new RTCSessionDescription(a)),En()}catch(t){let e=`WebRTC Error: ${t.message}`;t.message.includes("Failed to fetch")&&(e=`Server unavailable. Retrying in ${B/1e3}s...`),Y(e,"red"),t.message.includes("Failed to fetch")&&w.get("ui.currentPage")==="hud"&&(U=P(()=>{tt(),B=Math.min(B*_e,he)},B))}})}function En(){Ht(ht),_t=Date.now(),Dt=X.currentTime,ht=De(()=>{const n=Date.now();let t=!1,e="";n-_t>5e3&&(t=!0,e="Data stream stalled"),!t&&!X.paused&&X.currentTime===Dt&&(t=!0,e="Video stream stalled"),t&&(console.warn(`${e}. Attempting to reconnect...`),Y(`${e}. Reconnecting...`,"yellow"),tt()),Dt=X.currentTime},2e3)}function Tn(n){dt=n;const t=new TextDecoder("utf-8");let e="";n.onmessage=a=>{const i=typeof a.data=="string"?a.data:t.decode(a.data,{stream:!0});e+=i;let o;for(;(o=e.indexOf("}{"))!==-1;){const r=e.substring(0,o+1);s(r),e=e.substring(o+1)}e.length>0&&(s(e),e="")};function s(a){try{const i=JSON.parse(a.replace(_n,"null"));_t=Date.now();const o=Date.now();i.data&&i.data.dp_dev_dashy!==void 0&&An(i.data.dp_dev_dashy);const r=i.type;b[r]=i.data,b.recv_frame[r]=b.frame,b.recv_time[r]=o/1e3,b.updated[r]=!0,b.valid[r]=!0,b.seen[r]=!0,r==="selfdriveState"?(Ot=o,fe===0&&(fe=o,pe=b.frame)):r==="modelV2"?Mt=o:r==="carState"&&(kt=o),b.frame++}catch(i){}}}function An(n){de!==n&&(de=n)}function pt(n){if(!Ft.classList.contains("active")||document.hidden){window.animationFrameId=null;return}window.animationFrameId=requestAnimationFrame(pt);const t=n-xe;if(!(t<me)){if(xe=n-t%me,V.save(),V.clearRect(0,0,v.width,v.height),w.get("ui.hudModeEnabled")&&(V.translate(0,v.height),V.scale(1,-1)),O.is_metric=Rt,O.frame=b.frame,O.started_frame=pe,b.selfdriveState&&(O.engaged=b.selfdriveState.enabled||!1,b.selfdriveState.enabled?O.status="ENGAGED":b.selfdriveState.activeOverride?O.status="OVERRIDE":O.status="DISENGAGED"),$){const e={x:0,y:0,width:v.width,height:v.height};$.render(e,b,V)}wn(),V.restore();for(const e in b.updated)b.updated[e]=!1}}const gt=document.getElementById("hud-page"),Ln=document.querySelector("#files-table tbody"),zt=document.getElementById("hud-page-content"),st=document.getElementById("videoPlayer"),Se=document.getElementById("uiCanvas");let H,mt;function Rn(){document.addEventListener("click",n=>{if(n.target.matches("nav button")){const t=n.target.id.replace("nav-","");Ee(t);return}if(n.target.matches(".stepper button")){if(n.target.disabled){n.preventDefault();return}const t=n.target.parentElement,e=t.querySelector(".stepper-value"),s=parseFloat(n.target.dataset.step),a=t.dataset.min!==void 0?parseFloat(t.dataset.min):-1/0,i=t.dataset.max!==void 0?parseFloat(t.dataset.max):1/0;if(e.dataset.isTextSpin==="true"){const d=JSON.parse(t.dataset.textOptions||"[]");let l=parseInt(e.dataset.actualValue||0);if(s<0&&l<=0||s>0&&l>=d.length-1)return;let c=l+s;if(c=Math.max(0,Math.min(d.length-1,c)),c===l)return;e.dataset.actualValue=c,e.textContent=d[c],wt(t,c,0,d.length-1),yt(t.dataset.param,c);const h=t.dataset.param;h&&!t.dataset.storage&&Ct(h,c,!0)}else{const d=e.dataset.actualValue;if(d===void 0||d===""){console.error("actualValue not set for numeric spinner");return}let l=parseFloat(d);if(isNaN(l)){console.error("Invalid numeric value:",d);return}if(s<0&&l<=a||s>0&&l>=i)return;let c=l+s;if(String(s).includes(".")&&(c=parseFloat(c.toFixed(2))),c=Math.max(a,Math.min(i,c)),c===l)return;e.dataset.actualValue=c;const h=e.dataset.suffix||"",_=e.dataset.specialValueText||"",u=e.dataset.minVal!==""?parseFloat(e.dataset.minVal):a;_&&c===u?e.textContent=_:h?String(s).includes(".")?e.textContent=c.toFixed(1)+h:e.textContent=c+h:String(s).includes(".")?e.textContent=c.toFixed(1):e.textContent=c,wt(t,c,a,i),yt(t.dataset.param,c);const f=t.dataset.param;f&&!t.dataset.storage&&Ct(f,c,!0)}const r=n.target.closest("[data-param]");r&&r.dataset.storage==="local"&&P(()=>{const d=r.dataset.param,l=vt(!0)[d];l!==void 0&&ot(d,l)},50);return}if(n.target.matches(".btn-group button")){n.target.parentElement.querySelectorAll("button").forEach(s=>s.classList.remove("active")),n.target.classList.add("active");const e=n.target.closest("[data-param]");e&&e.dataset.storage==="local"&&P(()=>{const s=e.dataset.param,a=vt(!0)[s];a!==void 0&&ot(s,a)},50);return}if(n.target.matches("#files-table a, #files-breadcrumbs a")){if(n.target.href&&n.target.href.includes("/api/play"))return;const t=n.target.dataset.path;t!==void 0&&(n.preventDefault(),Zt(t));return}}),document.addEventListener("change",n=>{const t=n.target.closest("[data-param]");if(t){if(t.dataset.storage==="local")P(()=>{const e=t.dataset.param,s=vt(!0)[e];s!==void 0&&ot(e,s)},50);else if(n.target.matches('input[type="checkbox"]')){const e=t.dataset.param,s=n.target.checked;Ct(e,s,!1),yt(e,s?1:0)}}}),document.addEventListener("input",n=>{const t=n.target.closest('[data-param][data-storage="local"]');t&&n.target.matches(".text-input")&&ot(t.dataset.param,n.target.value)})}function Ee(n){const t=w.get("ui.currentPage");w.set("ui.currentPage",n),document.querySelectorAll(".page").forEach(e=>e.classList.remove("active")),document.querySelectorAll("nav button").forEach(e=>e.classList.remove("active")),document.getElementById(`${n}-page`).classList.add("active"),document.getElementById(`nav-${n}`).classList.add("active"),n==="files"&&!Ln.hasChildNodes()&&Zt("/"),t==="hud"&&n!=="hud"&&ft(),n==="hud"&&t!=="hud"&&tt(),n==="hud"?(H.classList.remove("visible"),w.set("ui.navBarVisible",!1),zt.addEventListener("click",at)):(H.classList.add("visible"),w.set("ui.navBarVisible",!0),zt.removeEventListener("click",at),clearTimeout(mt))}function at(){H||(H=document.querySelector("nav")),H.classList.toggle("visible"),H.classList.contains("visible")?(bt(mt),mt=P(()=>{H.classList.remove("visible")},3e3)):bt(mt)}function Dn(){return D(this,null,function*(){const n=document.getElementById("local-settings-content");Ue(n),H=document.querySelector("nav"),fn({hudPage:gt,videoWrapper:zt,videoPlayer:st,uiCanvas:Se}),Rn(),document.getElementById("hud-page-content").addEventListener("click",e=>{gt.classList.contains("active")&&at()}),st.addEventListener("click",e=>{gt.classList.contains("active")&&at()}),Se.addEventListener("click",e=>{gt.classList.contains("active")&&at()}),ze(st),Ve(),yield yn(),Ee("files"),st.onstalled=()=>{w.get("ui.currentPage")==="hud"&&(console.warn("Video stalled, attempting reconnect..."),tt())},st.onplaying=()=>{clearTimeout(U)}})}window.addEventListener("beforeunload",ft),window.addEventListener("unload",ft),Dn()})();
